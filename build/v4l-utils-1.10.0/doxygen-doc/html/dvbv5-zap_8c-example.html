<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>libdvbv5: dvbv5-zap.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libdvbv5
   &#160;<span id="projectnumber">1.10.0</span>
   </div>
   <div id="projectbrief">Library to work with Digital TV devices on Linux</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">dvbv5-zap.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Copyright (c) 2011-2012 - Mauro Carvalho Chehab</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is free software; you can redistribute it and/or</span></div><div class="line"><span class="comment"> * modify it under the terms of the GNU General Public License</span></div><div class="line"><span class="comment"> * as published by the Free Software Foundation version 2</span></div><div class="line"><span class="comment"> * of the License.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></div><div class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><span class="comment"> * GNU General Public License for more details.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></div><div class="line"><span class="comment"> * along with this program; if not, write to the Free Software</span></div><div class="line"><span class="comment"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA</span></div><div class="line"><span class="comment"> * Or, point your browser to http://www.gnu.org/licenses/old-licenses/gpl-2.0.html</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Based on dvb-apps tzap utility, made by:</span></div><div class="line"><span class="comment"> *      Bernard Hatt 24/2/04</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define _FILE_OFFSET_BITS 64</span></div><div class="line"><span class="preprocessor">#define _LARGEFILE_SOURCE 1</span></div><div class="line"><span class="preprocessor">#define _LARGEFILE64_SOURCE 1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;argp.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;config.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef ENABLE_NLS</span></div><div class="line"><span class="preprocessor"># define _(string) gettext(string)</span></div><div class="line"><span class="preprocessor"># include &quot;gettext.h&quot;</span></div><div class="line"><span class="preprocessor"># include &lt;locale.h&gt;</span></div><div class="line"><span class="preprocessor"># include &lt;langinfo.h&gt;</span></div><div class="line"><span class="preprocessor"># include &lt;iconv.h&gt;</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor"># define _(string) string</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor"># define N_(string) string</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;linux/dvb/dmx.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dvb-file_8h.html">libdvbv5/dvb-file.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dvb-demux_8h.html">libdvbv5/dvb-demux.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dvb-scan_8h.html">libdvbv5/dvb-scan.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="header_8h.html">libdvbv5/header.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="countries_8h.html">libdvbv5/countries.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define CHANNEL_FILE    &quot;channels.conf&quot;</span></div><div class="line"><span class="preprocessor">#define PROGRAM_NAME    &quot;dvbv5-zap&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *argp_program_version = PROGRAM_NAME <span class="stringliteral">&quot; version &quot;</span> V4L_UTILS_VERSION;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *argp_program_bug_address = <span class="stringliteral">&quot;Mauro Carvalho Chehab &lt;m.chehab@samsung.com&gt;&quot;</span>;</div><div class="line"></div><div class="line"><span class="keyword">struct </span>arguments {</div><div class="line">        <span class="keywordtype">char</span> *confname, *lnb_name, *output, *demux_dev, *dvr_dev;</div><div class="line">        <span class="keywordtype">char</span> *filename;</div><div class="line">        <span class="keywordtype">unsigned</span> adapter, frontend, demux, get_detected, get_nit;</div><div class="line">        <span class="keywordtype">int</span> force_dvbv3, lna, lnb, sat_number;</div><div class="line">        <span class="keywordtype">unsigned</span> diseqc_wait, silent, verbose, frontend_only, freq_bpf;</div><div class="line">        <span class="keywordtype">unsigned</span> timeout, dvr, rec_psi, exit_after_tuning;</div><div class="line">        <span class="keywordtype">unsigned</span> n_apid, n_vpid, all_pids;</div><div class="line">        <span class="keyword">enum</span> <a class="code" href="group__file.html#ga189e923df3b573ee1881bcd2a1329e36">dvb_file_formats</a> input_format, output_format;</div><div class="line">        <span class="keywordtype">unsigned</span> traffic_monitor, low_traffic;</div><div class="line">        <span class="keywordtype">char</span> *search;</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *cc;</div><div class="line"></div><div class="line">        <span class="comment">/* Used by status print */</span></div><div class="line">        <span class="keywordtype">unsigned</span> n_status_lines;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>argp_option options[] = {</div><div class="line">        {<span class="stringliteral">&quot;dvbv3&quot;</span>,       <span class="charliteral">&#39;3&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;Use DVBv3 only&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;adapter&quot;</span>,     <span class="charliteral">&#39;a&#39;</span>, N_(<span class="stringliteral">&quot;adapter#&quot;</span>),            0, N_(<span class="stringliteral">&quot;use given adapter (default 0)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;audio_pid&quot;</span>,   <span class="charliteral">&#39;A&#39;</span>, N_(<span class="stringliteral">&quot;audio_pid#&quot;</span>),          0, N_(<span class="stringliteral">&quot;audio pid program to use (default 0)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;channels&quot;</span>,    <span class="charliteral">&#39;c&#39;</span>, N_(<span class="stringliteral">&quot;file&quot;</span>),                0, N_(<span class="stringliteral">&quot;read channels list from &#39;file&#39;&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;demux&quot;</span>,       <span class="charliteral">&#39;d&#39;</span>, N_(<span class="stringliteral">&quot;demux#&quot;</span>),              0, N_(<span class="stringliteral">&quot;use given demux (default 0)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;frontend&quot;</span>,    <span class="charliteral">&#39;f&#39;</span>, N_(<span class="stringliteral">&quot;frontend#&quot;</span>),           0, N_(<span class="stringliteral">&quot;use given frontend (default 0)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;input-format&quot;</span>, <span class="charliteral">&#39;I&#39;</span>,   N_(<span class="stringliteral">&quot;format&quot;</span>),           0, N_(<span class="stringliteral">&quot;Input format: ZAP, CHANNEL, DVBV5 (default: DVBV5)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;lna&quot;</span>,         <span class="charliteral">&#39;w&#39;</span>, N_(<span class="stringliteral">&quot;LNA (0, 1, -1)&quot;</span>),      0, N_(<span class="stringliteral">&quot;enable/disable/auto LNA power&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;lnbf&quot;</span>,        <span class="charliteral">&#39;l&#39;</span>, N_(<span class="stringliteral">&quot;LNBf_type&quot;</span>),           0, N_(<span class="stringliteral">&quot;type of LNBf to use. &#39;help&#39; lists the available ones&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;search&quot;</span>,      <span class="charliteral">&#39;L&#39;</span>, N_(<span class="stringliteral">&quot;string&quot;</span>),              0, N_(<span class="stringliteral">&quot;search/look for a string inside the traffic&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;monitor&quot;</span>,     <span class="charliteral">&#39;m&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;monitors de DVB traffic&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;output&quot;</span>,      <span class="charliteral">&#39;o&#39;</span>, N_(<span class="stringliteral">&quot;file&quot;</span>),                0, N_(<span class="stringliteral">&quot;output filename (use -o - for stdout)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;pat&quot;</span>,         <span class="charliteral">&#39;p&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;add pat and pmt to TS recording (implies -r)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;all-pids&quot;</span>,    <span class="charliteral">&#39;P&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;don&#39;t filter any pids. Instead, outputs all of them&quot;</span>), 0 },</div><div class="line">        {<span class="stringliteral">&quot;record&quot;</span>,      <span class="charliteral">&#39;r&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;set up /dev/dvb/adapterX/dvr0 for TS recording&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;silence&quot;</span>,     <span class="charliteral">&#39;s&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;increases silence (can be used more than once)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;sat_number&quot;</span>,  <span class="charliteral">&#39;S&#39;</span>, N_(<span class="stringliteral">&quot;satellite_number&quot;</span>),    0, N_(<span class="stringliteral">&quot;satellite number. If not specified, disable DISEqC&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;timeout&quot;</span>,     <span class="charliteral">&#39;t&#39;</span>, N_(<span class="stringliteral">&quot;seconds&quot;</span>),             0, N_(<span class="stringliteral">&quot;timeout for zapping and for recording&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;freq_bpf&quot;</span>,    <span class="charliteral">&#39;U&#39;</span>, N_(<span class="stringliteral">&quot;frequency&quot;</span>),           0, N_(<span class="stringliteral">&quot;SCR/Unicable band-pass filter frequency to use, in kHz&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;verbose&quot;</span>,     <span class="charliteral">&#39;v&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;verbose debug messages (can be used more than once)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;video_pid&quot;</span>,   <span class="charliteral">&#39;V&#39;</span>, N_(<span class="stringliteral">&quot;video_pid#&quot;</span>),          0, N_(<span class="stringliteral">&quot;video pid program to use (default 0)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;wait&quot;</span>,        <span class="charliteral">&#39;W&#39;</span>, N_(<span class="stringliteral">&quot;time&quot;</span>),                0, N_(<span class="stringliteral">&quot;adds additional wait time for DISEqC command completion&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;exit&quot;</span>,        <span class="charliteral">&#39;x&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;exit after tuning&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;low_traffic&quot;</span>, <span class="charliteral">&#39;X&#39;</span>, NULL,                      0, N_(<span class="stringliteral">&quot;also shows DVB traffic with less then 1 packet per second&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;cc&quot;</span>,          <span class="charliteral">&#39;C&#39;</span>, N_(<span class="stringliteral">&quot;country_code&quot;</span>),        0, N_(<span class="stringliteral">&quot;Set the default country to be used (in ISO 3166-1 two letter code)&quot;</span>), 0},</div><div class="line">        {<span class="stringliteral">&quot;help&quot;</span>,        <span class="charliteral">&#39;?&#39;</span>,    0,              0,      N_(<span class="stringliteral">&quot;Give this help list&quot;</span>), -1},</div><div class="line">        {<span class="stringliteral">&quot;usage&quot;</span>,       -3,     0,              0,      N_(<span class="stringliteral">&quot;Give a short usage message&quot;</span>)},</div><div class="line">        {<span class="stringliteral">&quot;version&quot;</span>,     -4,     0,              0,      N_(<span class="stringliteral">&quot;Print program version&quot;</span>), -1},</div><div class="line">        { 0, 0, 0, 0, 0, 0 }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> timeout_flag = 0;</div><div class="line"></div><div class="line"><span class="preprocessor">#define ERROR(x...)                                                     \</span></div><div class="line"><span class="preprocessor">        do {                                                            \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, _(&quot;ERROR: &quot;));                             \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, x);                                     \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, &quot;\n&quot;);                                 \</span></div><div class="line"><span class="preprocessor">        } while (0)</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define PERROR(x...)                                                    \</span></div><div class="line"><span class="preprocessor">        do {                                                            \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, _(&quot;ERROR: &quot;));                             \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, x);                                     \</span></div><div class="line"><span class="preprocessor">                fprintf(stderr, &quot; (%s)\n&quot;, strerror(errno));            \</span></div><div class="line"><span class="preprocessor">        } while (0)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> parse(<span class="keyword">struct</span> arguments *args,</div><div class="line">                 <span class="keyword">struct</span> <a name="_a0"></a><a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms,</div><div class="line">                 <span class="keywordtype">char</span> *channel,</div><div class="line">                 <span class="keywordtype">int</span> *vpid, <span class="keywordtype">int</span> *apid, <span class="keywordtype">int</span> *sid)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span><a name="_a1"></a><a class="code" href="structdvb__file.html">dvb_file</a> *<a class="code" href="structdvb__file.html">dvb_file</a>;</div><div class="line">        <span class="keyword">struct </span><a name="_a2"></a><a class="code" href="structdvb__entry.html">dvb_entry</a> *entry;</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line">        uint32_t sys;</div><div class="line"></div><div class="line">        <span class="comment">/* This is used only when reading old formats */</span></div><div class="line">        <span class="keywordflow">switch</span> (parms-&gt;<a name="a3"></a><a class="code" href="structdvb__v5__fe__parms.html#af528ac7420efd3b29f4dfa456ee791ea">current_sys</a>) {</div><div class="line">        <span class="keywordflow">case</span> SYS_DVBT:</div><div class="line">        <span class="keywordflow">case</span> SYS_DVBS:</div><div class="line">        <span class="keywordflow">case</span> SYS_DVBC_ANNEX_A:</div><div class="line">        <span class="keywordflow">case</span> SYS_ATSC:</div><div class="line">                sys = parms-&gt;<a class="code" href="structdvb__v5__fe__parms.html#af528ac7420efd3b29f4dfa456ee791ea">current_sys</a>;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> SYS_DVBC_ANNEX_C:</div><div class="line">                sys = SYS_DVBC_ANNEX_A;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> SYS_DVBC_ANNEX_B:</div><div class="line">                sys = SYS_ATSC;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> SYS_ISDBT:</div><div class="line">        <span class="keywordflow">case</span> SYS_DTMB:</div><div class="line">                sys = SYS_DVBT;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">                sys = SYS_UNDEFINED;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        dvb_file = <a name="a4"></a><a class="code" href="group__file.html#gab79fb91f7e0dac68d977461fdefcb0c0">dvb_read_file_format</a>(args-&gt;confname, sys,</div><div class="line">                                    args-&gt;input_format);</div><div class="line">        <span class="keywordflow">if</span> (!dvb_file)</div><div class="line">                <span class="keywordflow">return</span> -2;</div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (entry = dvb_file-&gt;<a name="a5"></a><a class="code" href="structdvb__file.html#aa3487d57118a69c5dc113c8c6512a9d5">first_entry</a>; entry != NULL; entry = entry-&gt;<a name="a6"></a><a class="code" href="structdvb__entry.html#ab36ec69e316a685f2527cb2f2820cfe3">next</a>) {</div><div class="line">                <span class="keywordflow">if</span> (entry-&gt;<a name="a7"></a><a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a> &amp;&amp; !strcmp(entry-&gt;<a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>, <a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>))</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">if</span> (entry-&gt;<a name="a8"></a><a class="code" href="structdvb__entry.html#ae811cc0a7088eaaa18c5a834e6a51d2f">vchannel</a> &amp;&amp; !strcmp(entry-&gt;<a class="code" href="structdvb__entry.html#ae811cc0a7088eaaa18c5a834e6a51d2f">vchannel</a>, <a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>))</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Give a second shot, using a case insensitive seek</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keywordflow">if</span> (!entry) {</div><div class="line">                <span class="keywordflow">for</span> (entry = dvb_file-&gt;<a class="code" href="structdvb__file.html#aa3487d57118a69c5dc113c8c6512a9d5">first_entry</a>; entry != NULL;</div><div class="line">                     entry = entry-&gt;<a class="code" href="structdvb__entry.html#ab36ec69e316a685f2527cb2f2820cfe3">next</a>) {</div><div class="line">                        <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a> &amp;&amp; !strcasecmp(entry-&gt;<a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>, <a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>))</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * When this tool is used to just tune to a channel, to monitor it or</span></div><div class="line"><span class="comment">         * to capture all PIDs, all it needs is a frequency.</span></div><div class="line"><span class="comment">         * So, let the tool to accept a frequency as the tuning channel on those</span></div><div class="line"><span class="comment">         * cases.</span></div><div class="line"><span class="comment">         * This way, a file in &quot;channel&quot; format can be used instead of a zap file.</span></div><div class="line"><span class="comment">         * It is also easier to use it for testing purposes.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keywordflow">if</span> (!entry &amp;&amp; (args-&gt;traffic_monitor || args-&gt;all_pids || args-&gt;exit_after_tuning)) {</div><div class="line">                uint32_t f, freq = atoi(<a class="code" href="structdvb__entry.html#a95383462df05b5055212999cfb9af2fc">channel</a>);</div><div class="line">                <span class="keywordflow">if</span> (freq) {</div><div class="line">                        <span class="keywordflow">for</span> (entry = dvb_file-&gt;<a class="code" href="structdvb__file.html#aa3487d57118a69c5dc113c8c6512a9d5">first_entry</a>; entry != NULL;</div><div class="line">                        entry = entry-&gt;<a class="code" href="structdvb__entry.html#ab36ec69e316a685f2527cb2f2820cfe3">next</a>) {</div><div class="line">                                <a name="a9"></a><a class="code" href="group__file.html#ga45a0eea4649d09766b0d77f35f08bb0e">dvb_retrieve_entry_prop</a>(entry, DTV_FREQUENCY, &amp;f);</div><div class="line">                                <span class="keywordflow">if</span> (f == freq)</div><div class="line">                                        <span class="keywordflow">break</span>;</div><div class="line">                        }</div><div class="line"></div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!entry) {</div><div class="line">                ERROR(_(<span class="stringliteral">&quot;Can&#39;t find channel&quot;</span>));</div><div class="line">                <a name="a10"></a><a class="code" href="group__file.html#ga5dfc7d72e44db45d235f267d7fb8bc70">dvb_file_free</a>(dvb_file);</div><div class="line">                <span class="keywordflow">return</span> -3;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * Both the DVBv5 format and the command line parameters may</span></div><div class="line"><span class="comment">         * specify the LNBf. If both have the definition, use the one</span></div><div class="line"><span class="comment">         * provided by the command line parameter, overriding the one</span></div><div class="line"><span class="comment">         * stored in the channel file.</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keywordflow">if</span> (entry-&gt;<a name="a11"></a><a class="code" href="structdvb__entry.html#a16545c27b357e3144c04a224e9e61278">lnb</a> &amp;&amp; !parms-&gt;<a name="a12"></a><a class="code" href="structdvb__v5__fe__parms.html#ad9d556f33c37541df2b6277edd5ef9ab">lnb</a>) {</div><div class="line">                <span class="keywordtype">int</span> <a class="code" href="structdvb__entry.html#a16545c27b357e3144c04a224e9e61278">lnb</a> = <a name="a13"></a><a class="code" href="group__satellite.html#gac9cde4ada62dd033cdbc189835c620c7">dvb_sat_search_lnb</a>(entry-&gt;<a class="code" href="structdvb__entry.html#a16545c27b357e3144c04a224e9e61278">lnb</a>);</div><div class="line">                <span class="keywordflow">if</span> (lnb == -1) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;unknown LNB %s\n&quot;</span>), entry-&gt;<a class="code" href="structdvb__entry.html#a16545c27b357e3144c04a224e9e61278">lnb</a>);</div><div class="line">                        <a class="code" href="group__file.html#ga5dfc7d72e44db45d235f267d7fb8bc70">dvb_file_free</a>(dvb_file);</div><div class="line">                        <span class="keywordflow">return</span> -1;</div><div class="line">                }</div><div class="line">                parms-&gt;<a class="code" href="structdvb__v5__fe__parms.html#ad9d556f33c37541df2b6277edd5ef9ab">lnb</a> = <a name="a14"></a><a class="code" href="group__satellite.html#ga49547c0aaa0dfb610444b0e29755292c">dvb_sat_get_lnb</a>(lnb);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (entry-&gt;<a name="a15"></a><a class="code" href="structdvb__entry.html#a3d47b2030b0d018e142915631362a030">video_pid</a>) {</div><div class="line">                <span class="keywordflow">if</span> (args-&gt;n_vpid &lt; entry-&gt;<a name="a16"></a><a class="code" href="structdvb__entry.html#a4e3d53068d94826d7214bbd0bb4317c9">video_pid_len</a>)</div><div class="line">                        *vpid = entry-&gt;<a class="code" href="structdvb__entry.html#a3d47b2030b0d018e142915631362a030">video_pid</a>[args-&gt;n_vpid];</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                        *vpid = entry-&gt;<a class="code" href="structdvb__entry.html#a3d47b2030b0d018e142915631362a030">video_pid</a>[0];</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (entry-&gt;<a name="a17"></a><a class="code" href="structdvb__entry.html#a43222f11e4a5788718a2e2e789c546f1">audio_pid</a>) {</div><div class="line">                <span class="keywordflow">if</span> (args-&gt;n_apid &lt; entry-&gt;<a name="a18"></a><a class="code" href="structdvb__entry.html#a139e5b83d0100cdbbc9e66b2419b2878">audio_pid_len</a>)</div><div class="line">                        *apid = entry-&gt;<a class="code" href="structdvb__entry.html#a43222f11e4a5788718a2e2e789c546f1">audio_pid</a>[args-&gt;n_apid];</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                *apid = entry-&gt;<a class="code" href="structdvb__entry.html#a43222f11e4a5788718a2e2e789c546f1">audio_pid</a>[0];</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (entry-&gt;<a name="a19"></a><a class="code" href="structdvb__entry.html#a39e89bf2b7045a0b2a38ce9da9857e03">other_el_pid</a>) {</div><div class="line">                <span class="keywordtype">int</span> i, type = -1;</div><div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; entry-&gt;<a name="a20"></a><a class="code" href="structdvb__entry.html#a5daff6ffb17b970d2add0c1ac1d69870">other_el_pid_len</a>; i++) {</div><div class="line">                        <span class="keywordflow">if</span> (type != entry-&gt;<a class="code" href="structdvb__entry.html#a39e89bf2b7045a0b2a38ce9da9857e03">other_el_pid</a>[i].<a name="a21"></a><a class="code" href="structdvb__elementary__pid.html#a12da494504a547138f2f01581818d59a">type</a>) {</div><div class="line">                                type = entry-&gt;<a class="code" href="structdvb__entry.html#a39e89bf2b7045a0b2a38ce9da9857e03">other_el_pid</a>[i].<a class="code" href="structdvb__elementary__pid.html#a12da494504a547138f2f01581818d59a">type</a>;</div><div class="line">                                <span class="keywordflow">if</span> (i)</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;service has pid type %02x: &quot;</span>), type);</div><div class="line">                        }</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot; %d&quot;</span>, entry-&gt;<a class="code" href="structdvb__entry.html#a39e89bf2b7045a0b2a38ce9da9857e03">other_el_pid</a>[i].<a name="a22"></a><a class="code" href="structdvb__elementary__pid.html#a056e208bb2752181c5fc8d823dabe1a7">pid</a>);</div><div class="line">                }</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line">        }</div><div class="line">        *sid = entry-&gt;<a name="a23"></a><a class="code" href="structdvb__entry.html#aa8675380605ed6bdddb4d5ccce263a5b">service_id</a>;</div><div class="line"></div><div class="line">        <span class="comment">/* First of all, set the delivery system */</span></div><div class="line">        <a class="code" href="group__file.html#ga45a0eea4649d09766b0d77f35f08bb0e">dvb_retrieve_entry_prop</a>(entry, DTV_DELIVERY_SYSTEM, &amp;sys);</div><div class="line">        <a name="a24"></a><a class="code" href="group__frontend.html#ga5db3cc6a449e8a532ac07f0d198d7217">dvb_set_compat_delivery_system</a>(parms, sys);</div><div class="line"></div><div class="line">        <span class="comment">/* Copy data into parms */</span></div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; entry-&gt;<a name="a25"></a><a class="code" href="structdvb__entry.html#a37594dfcb911f719a590f012f732ed53">n_props</a>; i++) {</div><div class="line">                uint32_t data = entry-&gt;<a name="a26"></a><a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].u.data;</div><div class="line">                <span class="comment">/* Don&#39;t change the delivery system */</span></div><div class="line">                <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].cmd == DTV_DELIVERY_SYSTEM)</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                <a name="a27"></a><a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, entry-&gt;<a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].cmd, data);</div><div class="line">                <span class="keywordflow">if</span> (parms-&gt;<a class="code" href="structdvb__v5__fe__parms.html#af528ac7420efd3b29f4dfa456ee791ea">current_sys</a> == SYS_ISDBT) {</div><div class="line">                        <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_PARTIAL_RECEPTION, 0);</div><div class="line">                        <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_SOUND_BROADCASTING, 0);</div><div class="line">                        <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_LAYER_ENABLED, 0x07);</div><div class="line">                        <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].cmd == DTV_CODE_RATE_HP) {</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_LAYERA_FEC,</div><div class="line">                                                  data);</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_LAYERB_FEC,</div><div class="line">                                                  data);</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms, DTV_ISDBT_LAYERC_FEC,</div><div class="line">                                                  data);</div><div class="line">                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].cmd == DTV_MODULATION) {</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms,</div><div class="line">                                                  DTV_ISDBT_LAYERA_MODULATION,</div><div class="line">                                                  data);</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms,</div><div class="line">                                                  DTV_ISDBT_LAYERB_MODULATION,</div><div class="line">                                                  data);</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms,</div><div class="line">                                                  DTV_ISDBT_LAYERC_MODULATION,</div><div class="line">                                                  data);</div><div class="line">                        }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (parms-&gt;<a class="code" href="structdvb__v5__fe__parms.html#af528ac7420efd3b29f4dfa456ee791ea">current_sys</a> == SYS_ATSC &amp;&amp;</div><div class="line">                    entry-&gt;<a class="code" href="structdvb__entry.html#a38b8ff1806fed84a71b167f269a83bcf">props</a>[i].cmd == DTV_MODULATION) {</div><div class="line">                        <span class="keywordflow">if</span> (data != VSB_8 &amp;&amp; data != VSB_16)</div><div class="line">                                <a class="code" href="group__frontend.html#ga419ad7168a9f884346d74c997e1141b3">dvb_fe_store_parm</a>(parms,</div><div class="line">                                                  DTV_DELIVERY_SYSTEM,</div><div class="line">                                                  SYS_DVBC_ANNEX_B);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__file.html#ga5dfc7d72e44db45d235f267d7fb8bc70">dvb_file_free</a>(dvb_file);</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> setup_frontend(<span class="keyword">struct</span> arguments *args,</div><div class="line">                          <span class="keyword">struct</span> <a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line">        uint32_t freq;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args-&gt;silent &lt; 2) {</div><div class="line">                rc = <a name="a28"></a><a class="code" href="group__frontend.html#ga7fc5188032e1f4d15750b877924d1690">dvb_fe_retrieve_parm</a>(parms, DTV_FREQUENCY, &amp;freq);</div><div class="line">                <span class="keywordflow">if</span> (rc &lt; 0) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;can&#39;t get the frequency&quot;</span>));</div><div class="line">                        <span class="keywordflow">return</span> -1;</div><div class="line">                }</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;tuning to %i Hz\n&quot;</span>), freq);</div><div class="line">        }</div><div class="line"></div><div class="line">        rc = <a name="a29"></a><a class="code" href="group__frontend.html#gabde1041d5e55c41665da29bb121daf8a">dvb_fe_set_parms</a>(parms);</div><div class="line">        <span class="keywordflow">if</span> (rc &lt; 0) {</div><div class="line">                PERROR(_(<span class="stringliteral">&quot;dvb_fe_set_parms failed&quot;</span>));</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> do_timeout(<span class="keywordtype">int</span> x)</div><div class="line">{</div><div class="line">        (void)x;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (timeout_flag == 0) {</div><div class="line">                timeout_flag = 1;</div><div class="line">                alarm(2);</div><div class="line">                signal(SIGALRM, do_timeout);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <span class="comment">/* something has gone wrong ... exit */</span></div><div class="line">                exit(1);</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> print_frontend_stats(FILE *fd,</div><div class="line">                                <span class="keyword">struct</span> arguments *args,</div><div class="line">                                <span class="keyword">struct</span> <a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> buf[512], *p;</div><div class="line">        <span class="keywordtype">int</span> rc, i, len, show;</div><div class="line">        uint32_t status = 0;</div><div class="line"></div><div class="line">        <span class="comment">/* Move cursor up and cleans down */</span></div><div class="line">        <span class="keywordflow">if</span> (isatty(fileno(fd)) &amp;&amp; args-&gt;n_status_lines)</div><div class="line">                fprintf(fd, <span class="stringliteral">&quot;\r\x1b[%dA\x1b[J&quot;</span>, args-&gt;n_status_lines);</div><div class="line"></div><div class="line">        args-&gt;n_status_lines = 0;</div><div class="line"></div><div class="line">        rc = <a name="a30"></a><a class="code" href="group__frontend.html#gafb6b35003768d938a4e1623d9fb82baa">dvb_fe_get_stats</a>(parms);</div><div class="line">        <span class="keywordflow">if</span> (rc) {</div><div class="line">                PERROR(_(<span class="stringliteral">&quot;dvb_fe_get_stats failed&quot;</span>));</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        p = buf;</div><div class="line">        len = <span class="keyword">sizeof</span>(buf);</div><div class="line">        <a name="a31"></a><a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms,  <a name="a32"></a><a class="code" href="group__frontend.html#ga6b9d1ac1e7f098f2e189408c573957a1">DTV_STATUS</a>, NULL, 0, &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">        <span class="keywordflow">for</span> (i = 0; i &lt; MAX_DTV_STATS; i++) {</div><div class="line">                show = 1;</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, <a name="a33"></a><a class="code" href="group__frontend.html#gaa73136f5485832d7094d3cad6885798c">DTV_QUALITY</a>, _(<span class="stringliteral">&quot;Quality&quot;</span>),</div><div class="line">                                     i, &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, DTV_STAT_SIGNAL_STRENGTH, _(<span class="stringliteral">&quot;Signal&quot;</span>),</div><div class="line">                                     i, &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, DTV_STAT_CNR, _(<span class="stringliteral">&quot;C/N&quot;</span>),</div><div class="line">                                     i, &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, DTV_STAT_ERROR_BLOCK_COUNT, _(<span class="stringliteral">&quot;UCB&quot;</span>),</div><div class="line">                                     i,  &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, <a name="a34"></a><a class="code" href="group__frontend.html#ga0a380404fc053ab72d8093a5acf60103">DTV_BER</a>, _(<span class="stringliteral">&quot;postBER&quot;</span>),</div><div class="line">                                     i,  &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, <a name="a35"></a><a class="code" href="group__frontend.html#gade8a86029dae354c98ce75825fff8f37">DTV_PRE_BER</a>, _(<span class="stringliteral">&quot;preBER&quot;</span>),</div><div class="line">                                     i,  &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <a class="code" href="group__frontend.html#ga5537a2ab838f8814c5d22d90c648b3d5">dvb_fe_snprintf_stat</a>(parms, <a name="a36"></a><a class="code" href="group__frontend.html#gaae80c2c97096e7cfbf5a8c2de5eb5001">DTV_PER</a>, _(<span class="stringliteral">&quot;PER&quot;</span>),</div><div class="line">                                     i,  &amp;p, &amp;len, &amp;show);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (p != buf) {</div><div class="line">                        <span class="keywordflow">if</span> (args-&gt;n_status_lines)</div><div class="line">                                fprintf(fd, <span class="stringliteral">&quot;\t%s\n&quot;</span>, buf);</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                                fprintf(fd, <span class="stringliteral">&quot;%s\n&quot;</span>, buf);</div><div class="line"></div><div class="line">                        args-&gt;n_status_lines++;</div><div class="line"></div><div class="line">                        p = buf;</div><div class="line">                        len = <span class="keyword">sizeof</span>(buf);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        fflush(fd);</div><div class="line"></div><div class="line">        <span class="comment">/* While not lock, display status on a new line */</span></div><div class="line">        <a name="a37"></a><a class="code" href="group__frontend.html#ga3ad32e6b435b72a08154c9de86368b1e">dvb_fe_retrieve_stats</a>(parms, <a class="code" href="group__frontend.html#ga6b9d1ac1e7f098f2e189408c573957a1">DTV_STATUS</a>, &amp;status);</div><div class="line">        <span class="keywordflow">if</span> (!isatty(fileno(fd)) || !(status &amp; FE_HAS_LOCK))</div><div class="line">                fprintf(fd, <span class="stringliteral">&quot;\n&quot;</span>);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> check_frontend(<span class="keyword">struct</span> arguments *args,</div><div class="line">                          <span class="keyword">struct</span> <a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line">        fe_status_t status = 0;</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">                rc = <a class="code" href="group__frontend.html#gafb6b35003768d938a4e1623d9fb82baa">dvb_fe_get_stats</a>(parms);</div><div class="line">                <span class="keywordflow">if</span> (rc) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;dvb_fe_get_stats failed&quot;</span>));</div><div class="line">                        usleep(1000000);</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                status = 0;</div><div class="line">                rc = <a class="code" href="group__frontend.html#ga3ad32e6b435b72a08154c9de86368b1e">dvb_fe_retrieve_stats</a>(parms, <a class="code" href="group__frontend.html#ga6b9d1ac1e7f098f2e189408c573957a1">DTV_STATUS</a>, &amp;status);</div><div class="line">                <span class="keywordflow">if</span> (!args-&gt;silent)</div><div class="line">                        print_frontend_stats(stderr, args, parms);</div><div class="line">                <span class="keywordflow">if</span> (status &amp; FE_HAS_LOCK)</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                usleep(1000000);</div><div class="line">        } <span class="keywordflow">while</span> (!timeout_flag);</div><div class="line">        <span class="keywordflow">if</span> (args-&gt;silent &lt; 2)</div><div class="line">                print_frontend_stats(stderr, args, parms);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> status &amp; FE_HAS_LOCK;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> get_show_stats(<span class="keyword">struct</span> arguments *args,</div><div class="line">                           <span class="keyword">struct</span> <a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms,</div><div class="line">                           <span class="keywordtype">int</span> loop)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> rc;</div><div class="line"></div><div class="line">        args-&gt;n_status_lines = 0;</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">                rc = <a class="code" href="group__frontend.html#gafb6b35003768d938a4e1623d9fb82baa">dvb_fe_get_stats</a>(parms);</div><div class="line">                <span class="keywordflow">if</span> (!rc)</div><div class="line">                        print_frontend_stats(stderr, args, parms);</div><div class="line">                <span class="keywordflow">if</span> (!timeout_flag &amp;&amp; loop)</div><div class="line">                        usleep(1000000);</div><div class="line">        } <span class="keywordflow">while</span> (!timeout_flag &amp;&amp; loop);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#define BUFLEN (188 * 256)</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> copy_to_file(<span class="keywordtype">int</span> in_fd, <span class="keywordtype">int</span> out_fd, <span class="keywordtype">int</span> timeout, <span class="keywordtype">int</span> silent)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> buf[BUFLEN];</div><div class="line">        <span class="keywordtype">int</span> r;</div><div class="line">        <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> rc = 0LL;</div><div class="line">        <span class="keywordflow">while</span> (timeout_flag == 0) {</div><div class="line">                r = read(in_fd, buf, BUFLEN);</div><div class="line">                <span class="keywordflow">if</span> (r &lt; 0) {</div><div class="line">                        <span class="keywordflow">if</span> (errno == EOVERFLOW) {</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;buffer overrun\n&quot;</span>));</div><div class="line">                                <span class="keywordflow">continue</span>;</div><div class="line">                        }</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;Read failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (write(out_fd, buf, r) &lt; 0) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;Write failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                rc += r;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (silent &lt; 2) {</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;copied %lld bytes (%lld Kbytes/sec)\n&quot;</span>), rc,</div><div class="line">                        rc / (1024 * timeout));</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> error_t parse_opt(<span class="keywordtype">int</span> k, <span class="keywordtype">char</span> *optarg, <span class="keyword">struct</span> argp_state *state)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span>arguments *args = state-&gt;input;</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (k) {</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:</div><div class="line">                args-&gt;adapter = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:</div><div class="line">                args-&gt;frontend = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div><div class="line">                args-&gt;demux = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:</div><div class="line">                args-&gt;timeout = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:</div><div class="line">                args-&gt;input_format = <a name="a38"></a><a class="code" href="group__file.html#gacfdc20d393ac4b0db8e830190491b506">dvb_parse_format</a>(optarg);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:</div><div class="line">                args-&gt;filename = strdup(optarg);</div><div class="line">                <span class="comment">/* fall through */</span></div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div><div class="line">                args-&gt;dvr = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div><div class="line">                args-&gt;rec_psi = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>:</div><div class="line">                args-&gt;exit_after_tuning = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div><div class="line">                args-&gt;confname = strdup(optarg);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>:</div><div class="line">                <span class="keywordflow">if</span> (!strcasecmp(optarg,<span class="stringliteral">&quot;on&quot;</span>)) {</div><div class="line">                        args-&gt;lna = 1;</div><div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg,<span class="stringliteral">&quot;off&quot;</span>)) {</div><div class="line">                        args-&gt;lna = 0;</div><div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(optarg,<span class="stringliteral">&quot;auto&quot;</span>)) {</div><div class="line">                        args-&gt;lna = LNA_AUTO;</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                        <span class="keywordtype">int</span> val = strtoul(optarg, NULL, 0);</div><div class="line">                        <span class="keywordflow">if</span> (!val)</div><div class="line">                                args-&gt;lna = 0;</div><div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val &gt; 0)</div><div class="line">                                args-&gt;lna = 1;</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                                args-&gt;lna = LNA_AUTO;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:</div><div class="line">                args-&gt;lnb_name = strdup(optarg);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div><div class="line">                args-&gt;sat_number = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span>:</div><div class="line">                args-&gt;freq_bpf = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;W&#39;</span>:</div><div class="line">                args-&gt;diseqc_wait = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div><div class="line">                args-&gt;silent++;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div><div class="line">                args-&gt;verbose++;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>:</div><div class="line">                args-&gt;n_apid = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span>:</div><div class="line">                args-&gt;n_vpid = strtoul(optarg, NULL, 0);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:</div><div class="line">                args-&gt;all_pids++;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;3&#39;</span>:</div><div class="line">                args-&gt;force_dvbv3 = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div><div class="line">                args-&gt;traffic_monitor = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;X&#39;</span>:</div><div class="line">                args-&gt;low_traffic = 1;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:</div><div class="line">                args-&gt;search = strdup(optarg);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>:</div><div class="line">                args-&gt;cc = strndup(optarg, 2);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div><div class="line">                argp_state_help(state, state-&gt;out_stream,</div><div class="line">                                ARGP_HELP_SHORT_USAGE | ARGP_HELP_LONG</div><div class="line">                                | ARGP_HELP_DOC);</div><div class="line">                fprintf(state-&gt;out_stream, _(<span class="stringliteral">&quot;\nReport bugs to %s.\n&quot;</span>), argp_program_bug_address);</div><div class="line">                exit(0);</div><div class="line">        <span class="keywordflow">case</span> -4:</div><div class="line">                fprintf (state-&gt;out_stream, <span class="stringliteral">&quot;%s\n&quot;</span>, argp_program_version);</div><div class="line">                exit(0);</div><div class="line">        <span class="keywordflow">case</span> -3:</div><div class="line">                argp_state_help(state, state-&gt;out_stream, ARGP_HELP_USAGE);</div><div class="line">                exit(0);</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">                <span class="keywordflow">return</span> ARGP_ERR_UNKNOWN;</div><div class="line">        };</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#define BSIZE 188</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> do_traffic_monitor(<span class="keyword">struct</span> arguments *args,</div><div class="line">                    <span class="keyword">struct</span> <a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> fd, dvr_fd;</div><div class="line">        <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> pidt[0x2001], wait;</div><div class="line">        <span class="keywordtype">int</span> packets = 0;</div><div class="line">        <span class="keyword">struct </span>timeval startt;</div><div class="line"></div><div class="line">        memset(pidt, 0, <span class="keyword">sizeof</span>(pidt));</div><div class="line"></div><div class="line">        args-&gt;exit_after_tuning = 1;</div><div class="line">        check_frontend(args, parms);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((dvr_fd = open(args-&gt;dvr_dev, O_RDONLY)) &lt; 0) {</div><div class="line">                PERROR(_(<span class="stringliteral">&quot;failed opening &#39;%s&#39;&quot;</span>), args-&gt;dvr_dev);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (ioctl(dvr_fd, DMX_SET_BUFFER_SIZE, 1024 * 1024) == -1)</div><div class="line">                perror(_(<span class="stringliteral">&quot;DMX_SET_BUFFER_SIZE failed&quot;</span>));</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((fd = open(args-&gt;demux_dev, O_RDWR)) &lt; 0) {</div><div class="line">                PERROR(_(<span class="stringliteral">&quot;failed opening &#39;%s&#39;&quot;</span>), args-&gt;demux_dev);</div><div class="line">                close(dvr_fd);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args-&gt;silent &lt; 2)</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;  dvb_set_pesfilter to 0x2000\n&quot;</span>));</div><div class="line">        <span class="keywordflow">if</span> (<a name="a39"></a><a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(fd, 0x2000, DMX_PES_OTHER,</div><div class="line">                              DMX_OUT_TS_TAP, 0) &lt; 0) {</div><div class="line">                PERROR(_(<span class="stringliteral">&quot;couldn&#39;t set filter&quot;</span>));</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        gettimeofday(&amp;startt, 0);</div><div class="line">        wait = 1000;</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> (1) {</div><div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[BSIZE];</div><div class="line">                <span class="keyword">struct </span><a name="_a40"></a><a class="code" href="structdvb__ts__packet__header.html">dvb_ts_packet_header</a> *h = (<span class="keywordtype">void</span> *)buffer;</div><div class="line">                <span class="keywordtype">int</span> <a name="a41"></a><a class="code" href="structdvb__ts__packet__header.html#a1383e610329bc0134450455aa872fba2">pid</a>, ok;</div><div class="line">                ssize_t r;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (timeout_flag)</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> ((r = read(dvr_fd, buffer, BSIZE)) &lt;= 0) {</div><div class="line">                        <span class="keywordflow">if</span> (errno == EOVERFLOW) {</div><div class="line">                                <span class="keyword">struct </span>timeval now;</div><div class="line">                                <span class="keywordtype">int</span> diff;</div><div class="line">                                gettimeofday(&amp;now, 0);</div><div class="line">                                diff =</div><div class="line">                                    (now.tv_sec - startt.tv_sec) * 1000 +</div><div class="line">                                    (now.tv_usec - startt.tv_usec) / 1000;</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;%.2fs: buffer overrun\n&quot;</span>), diff / 1000.);</div><div class="line">                                <span class="keywordflow">continue</span>;</div><div class="line">                        }</div><div class="line">                        perror(_(<span class="stringliteral">&quot;read&quot;</span>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (r != BSIZE) {</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;dvbtraffic: only read %zd bytes\n&quot;</span>), r);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (h-&gt;<a name="a42"></a><a class="code" href="structdvb__ts__packet__header.html#a2a3811644925626e8d5f143b6af2840c">sync_byte</a> != 0x47) {</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line">                }</div><div class="line"></div><div class="line">                bswap16(h-&gt;<a name="a43"></a><a class="code" href="structdvb__ts__packet__header.html#adf0fe142994eeab29d9991ce3d28a25b">bitfield</a>);</div><div class="line"></div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line">                <span class="comment">/*</span></div><div class="line"><span class="comment">                 * ITU-T Rec. H.222.0 decoders shall discard Transport Stream</span></div><div class="line"><span class="comment">                 * packets with theadaptation_field_control field set to</span></div><div class="line"><span class="comment">                 * a value of &#39;00&#39;.</span></div><div class="line"><span class="comment">                 */</span></div><div class="line">                <span class="keywordflow">if</span> (h-&gt;<a name="a44"></a><a class="code" href="structdvb__ts__packet__header.html#ad9172791d44af152c802a8c0c816d4fa">adaptation_field_control</a> == 0)</div><div class="line">                        <span class="keywordflow">continue</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                ok = 1;</div><div class="line">                pid = h-&gt;<a class="code" href="structdvb__ts__packet__header.html#a1383e610329bc0134450455aa872fba2">pid</a>;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (args-&gt;search) {</div><div class="line">                        <span class="keywordtype">int</span> i, sl = strlen(args-&gt;search);</div><div class="line">                        ok = 0;</div><div class="line">                        <span class="keywordflow">if</span> (pid != 0x1fff) {</div><div class="line">                                <span class="keywordflow">for</span> (i = 0; i &lt; (188 - sl); ++i) {</div><div class="line">                                        <span class="keywordflow">if</span> (!memcmp(buffer + i, args-&gt;search, sl))</div><div class="line">                                                ok = 1;</div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (ok) {</div><div class="line">                        pidt[pid]++;</div><div class="line">                        pidt[0x2000]++;</div><div class="line">                }</div><div class="line"></div><div class="line">                packets++;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (!(packets &amp; 0xFF)) {</div><div class="line">                        <span class="keyword">struct </span>timeval now;</div><div class="line">                        <span class="keywordtype">int</span> diff;</div><div class="line">                        gettimeofday(&amp;now, 0);</div><div class="line">                        diff =</div><div class="line">                            (now.tv_sec - startt.tv_sec) * 1000 +</div><div class="line">                            (now.tv_usec - startt.tv_usec) / 1000;</div><div class="line">                        <span class="keywordflow">if</span> (diff &gt; wait) {</div><div class="line">                                <span class="keywordflow">if</span> (isatty(STDOUT_FILENO))</div><div class="line">                                        printf(<span class="stringliteral">&quot;\x1b[1H\x1b[2J&quot;</span>);</div><div class="line"></div><div class="line">                                args-&gt;n_status_lines = 0;</div><div class="line">                                printf(_(<span class="stringliteral">&quot; PID          FREQ         SPEED       TOTAL\n&quot;</span>));</div><div class="line">                                <span class="keywordtype">int</span> _pid = 0;</div><div class="line">                                <span class="keywordflow">for</span> (_pid = 0; _pid &lt; 0x2000; _pid++) {</div><div class="line">                                        <span class="keywordflow">if</span> (pidt[_pid]) {</div><div class="line">                                                <span class="keywordflow">if</span> (!args-&gt;low_traffic &amp;&amp; (pidt[_pid] * 1000. / diff) &lt; 1)</div><div class="line">                                                        <span class="keywordflow">continue</span>;</div><div class="line">                                                printf(<span class="stringliteral">&quot;%04x %9.2f p/s %8.1f Kbps &quot;</span>,</div><div class="line">                                                     _pid,</div><div class="line">                                                     pidt[_pid] * 1000. / diff,</div><div class="line">                                                     pidt[_pid] * 1000. / diff * 8 * 188 / 1024);</div><div class="line">                                                <span class="keywordflow">if</span> (pidt[_pid] * 188 / 1024)</div><div class="line">                                                        printf(<span class="stringliteral">&quot;%8llu KB\n&quot;</span>, pidt[_pid] * 188 / 1024);</div><div class="line">                                                <span class="keywordflow">else</span></div><div class="line">                                                        printf(<span class="stringliteral">&quot; %8llu B\n&quot;</span>, pidt[_pid] * 188);</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="comment">/* 0x2000 is the total traffic */</span></div><div class="line">                                printf(<span class="stringliteral">&quot;TOT %10.2f p/s %8.1f Kbps %8llu KB\n&quot;</span>,</div><div class="line">                                     pidt[_pid] * 1000. / diff,</div><div class="line">                                     pidt[_pid] * 1000. / diff * 8 * 188 / 1024,</div><div class="line">                                     pidt[_pid] * 188 / 1024);</div><div class="line">                                printf(<span class="stringliteral">&quot;\n\n&quot;</span>);</div><div class="line">                                get_show_stats(args, parms, 0);</div><div class="line">                                wait += 1000;</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line">        close(dvr_fd);</div><div class="line">        close(fd);</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span>arguments args;</div><div class="line">        <span class="keywordtype">char</span> *homedir = getenv(<span class="stringliteral">&quot;HOME&quot;</span>);</div><div class="line">        <span class="keywordtype">char</span> *channel = NULL;</div><div class="line">        <span class="keywordtype">int</span> lnb = -1, idx = -1;</div><div class="line">        <span class="keywordtype">int</span> vpid = -1, apid = -1, sid = -1;</div><div class="line">        <span class="keywordtype">int</span> pmtpid = 0;</div><div class="line">        <span class="keywordtype">int</span> pat_fd = -1, pmt_fd = -1, sid_fd = -1;</div><div class="line">        <span class="keywordtype">int</span> audio_fd = -1, video_fd = -1;</div><div class="line">        <span class="keywordtype">int</span> dvr_fd = -1, file_fd = -1;</div><div class="line">        <span class="keywordtype">int</span> err = -1;</div><div class="line">        <span class="keywordtype">int</span> r;</div><div class="line">        <span class="keyword">struct </span><a class="code" href="structdvb__v5__fe__parms.html">dvb_v5_fe_parms</a> *parms = NULL;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span>argp argp = {</div><div class="line">                .options = options,</div><div class="line">                .parser = parse_opt,</div><div class="line">                .doc = N_(<span class="stringliteral">&quot;DVB zap utility&quot;</span>),</div><div class="line">                .args_doc = N_(<span class="stringliteral">&quot;&lt;channel name&gt; [or &lt;frequency&gt; if in monitor mode]&quot;</span>),</div><div class="line">        };</div><div class="line"></div><div class="line"><span class="preprocessor">#ifdef ENABLE_NLS</span></div><div class="line">        setlocale (LC_ALL, <span class="stringliteral">&quot;&quot;</span>);</div><div class="line">        bindtextdomain (PACKAGE, LOCALEDIR);</div><div class="line">        textdomain (PACKAGE);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">        memset(&amp;args, 0, <span class="keyword">sizeof</span>(args));</div><div class="line">        args.sat_number = -1;</div><div class="line">        args.lna = LNA_AUTO;</div><div class="line">        args.input_format = <a name="a45"></a><a class="code" href="dvb-file_8h.html#ga189e923df3b573ee1881bcd2a1329e36a742500f2ded5a51f20f42439d59ed521">FILE_DVBV5</a>;</div><div class="line"></div><div class="line">        argp_parse(&amp;argp, argc, argv, ARGP_NO_HELP | ARGP_NO_EXIT, &amp;idx, &amp;args);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (idx &lt; argc)</div><div class="line">                channel = argv[idx];</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!channel) {</div><div class="line">                argp_help(&amp;argp, stderr, ARGP_HELP_STD_HELP, PROGRAM_NAME);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.input_format == <a name="a46"></a><a class="code" href="dvb-file_8h.html#ga189e923df3b573ee1881bcd2a1329e36a55595a23fcfe87b437a8129aa1548e15">FILE_UNKNOWN</a>) {</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;ERROR: Please specify a valid format\n&quot;</span>));</div><div class="line">                argp_help(&amp;argp, stderr, ARGP_HELP_STD_HELP, PROGRAM_NAME);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!args.traffic_monitor &amp;&amp; args.search) {</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;ERROR: search string can be used only on monitor mode\n&quot;</span>));</div><div class="line">                argp_help(&amp;argp, stderr, ARGP_HELP_STD_HELP, PROGRAM_NAME);</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.lnb_name) {</div><div class="line">                lnb = <a class="code" href="group__satellite.html#gac9cde4ada62dd033cdbc189835c620c7">dvb_sat_search_lnb</a>(args.lnb_name);</div><div class="line">                <span class="keywordflow">if</span> (lnb &lt; 0) {</div><div class="line">                        printf(_(<span class="stringliteral">&quot;Please select one of the LNBf&#39;s below:\n&quot;</span>));</div><div class="line">                        <a name="a47"></a><a class="code" href="group__satellite.html#ga331da0c0d4a550eb197a9cde59130c1e">dvb_print_all_lnb</a>();</div><div class="line">                        exit(1);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                        printf(_(<span class="stringliteral">&quot;Using LNBf &quot;</span>));</div><div class="line">                        <a name="a48"></a><a class="code" href="group__satellite.html#ga7662df9e20b4d2e1c8f1bebb3b347fd7">dvb_print_lnb</a>(lnb);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        r = asprintf(&amp;args.demux_dev,</div><div class="line">                 <span class="stringliteral">&quot;/dev/dvb/adapter%i/demux%i&quot;</span>, args.adapter, args.demux);</div><div class="line">        <span class="keywordflow">if</span> (r &lt; 0) {</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;asprintf error\n&quot;</span>));</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        r = asprintf(&amp;args.dvr_dev,</div><div class="line">                 <span class="stringliteral">&quot;/dev/dvb/adapter%i/dvr%i&quot;</span>, args.adapter, args.demux);</div><div class="line">        <span class="keywordflow">if</span> (r &lt; 0) {</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;asprintf error\n&quot;</span>));</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;using demux &#39;%s&#39;\n&quot;</span>), args.demux_dev);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!args.confname) {</div><div class="line">                <span class="keywordflow">if</span> (!homedir)</div><div class="line">                        ERROR(_(<span class="stringliteral">&quot;$HOME not set&quot;</span>));</div><div class="line">                r = asprintf(&amp;args.confname, <span class="stringliteral">&quot;%s/.tzap/%i/%s&quot;</span>,</div><div class="line">                         homedir, args.adapter, CHANNEL_FILE);</div><div class="line">                <span class="keywordflow">if</span> (access(args.confname, R_OK)) {</div><div class="line">                        free(args.confname);</div><div class="line">                        r = asprintf(&amp;args.confname, <span class="stringliteral">&quot;%s/.tzap/%s&quot;</span>,</div><div class="line">                                homedir, CHANNEL_FILE);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        fprintf(stderr, _(<span class="stringliteral">&quot;reading channels from file &#39;%s&#39;\n&quot;</span>), args.confname);</div><div class="line"></div><div class="line">        parms = <a name="a49"></a><a class="code" href="group__frontend.html#ga81ff447a3ae2732523f32a03c85a2d8e">dvb_fe_open</a>(args.adapter, args.frontend, args.verbose, args.force_dvbv3);</div><div class="line">        <span class="keywordflow">if</span> (!parms)</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        <span class="keywordflow">if</span> (lnb &gt;= 0)</div><div class="line">                parms-&gt;<a class="code" href="structdvb__v5__fe__parms.html#ad9d556f33c37541df2b6277edd5ef9ab">lnb</a> = <a class="code" href="group__satellite.html#ga49547c0aaa0dfb610444b0e29755292c">dvb_sat_get_lnb</a>(lnb);</div><div class="line">        <span class="keywordflow">if</span> (args.sat_number &gt; 0)</div><div class="line">                parms-&gt;<a name="a50"></a><a class="code" href="structdvb__v5__fe__parms.html#a96c8ea5eb5ae3a69671af245efab7dd9">sat_number</a> = args.sat_number % 3;</div><div class="line">        parms-&gt;<a name="a51"></a><a class="code" href="structdvb__v5__fe__parms.html#a7904d056b88d48c39c8fef242b963539">diseqc_wait</a> = args.diseqc_wait;</div><div class="line">        parms-&gt;<a name="a52"></a><a class="code" href="structdvb__v5__fe__parms.html#a304dc4d27ecfea9095ce292c8af7ae8a">freq_bpf</a> = args.freq_bpf;</div><div class="line">        parms-&gt;<a name="a53"></a><a class="code" href="structdvb__v5__fe__parms.html#a0a61f74a8d249a678e23068d92c28759">lna</a> = args.lna;</div><div class="line"></div><div class="line">        r = <a name="a54"></a><a class="code" href="group__frontend.html#ga06b0458138f4633cee4c02097bda531a">dvb_fe_set_default_country</a>(parms, args.cc);</div><div class="line">        <span class="keywordflow">if</span> (r &lt; 0)</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;Failed to set the country code:%s\n&quot;</span>), args.cc);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (parse(&amp;args, parms, channel, &amp;vpid, &amp;apid, &amp;sid))</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (setup_frontend(&amp;args, parms) &lt; 0)</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.exit_after_tuning) {</div><div class="line">                err = 0;</div><div class="line">                check_frontend(&amp;args, parms);</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.traffic_monitor) {</div><div class="line">                signal(SIGTERM, do_timeout);</div><div class="line">                signal(SIGINT, do_timeout);</div><div class="line">                <span class="keywordflow">if</span> (args.timeout &gt; 0) {</div><div class="line">                        signal(SIGINT, do_timeout);</div><div class="line">                        alarm(args.timeout);</div><div class="line">                }</div><div class="line"></div><div class="line">                err = do_traffic_monitor(&amp;args, parms);</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.rec_psi) {</div><div class="line">                <span class="keywordflow">if</span> (sid &lt; 0) {</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;Service id 0x%04x was not specified at the file\n&quot;</span>),</div><div class="line">                                sid);</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line"></div><div class="line">                sid_fd = <a name="a55"></a><a class="code" href="group__demux.html#gafe9e70b0502b1ea1c754d6f77de7b9c0">dvb_dmx_open</a>(args.adapter, args.demux);</div><div class="line">                <span class="keywordflow">if</span> (sid_fd &lt; 0) {</div><div class="line">                        perror(_(<span class="stringliteral">&quot;opening pat demux failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">return</span> -1;</div><div class="line">                }</div><div class="line">                pmtpid = <a name="a56"></a><a class="code" href="group__demux.html#ga2cdec4d5a6b3af4ea66f423a847761dc">dvb_get_pmt_pid</a>(sid_fd, sid);</div><div class="line">                <a name="a57"></a><a class="code" href="group__demux.html#gad6baf1e5266bc38063723a87582ce4f9">dvb_dmx_close</a>(sid_fd);</div><div class="line">                <span class="keywordflow">if</span> (pmtpid &lt;= 0) {</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;couldn&#39;t find pmt-pid for sid %04x\n&quot;</span>),</div><div class="line">                                sid);</div><div class="line"></div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> ((pat_fd = open(args.demux_dev, O_RDWR)) &lt; 0) {</div><div class="line">                        perror(_(<span class="stringliteral">&quot;opening pat demux failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(pat_fd, 0, DMX_PES_OTHER,</div><div class="line">                                args.dvr ? DMX_OUT_TS_TAP : DMX_OUT_DECODER,</div><div class="line">                                args.dvr ? 64 * 1024 : 0) &lt; 0)</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> ((pmt_fd = open(args.demux_dev, O_RDWR)) &lt; 0) {</div><div class="line">                        perror(_(<span class="stringliteral">&quot;opening pmt demux failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(pmt_fd, pmtpid, DMX_PES_OTHER,</div><div class="line">                                args.dvr ? DMX_OUT_TS_TAP : DMX_OUT_DECODER,</div><div class="line">                                args.dvr ? 64 * 1024 : 0) &lt; 0)</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.all_pids++) {</div><div class="line">                vpid = 0x2000;</div><div class="line">                apid = 0;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (vpid &gt;= 0) {</div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2) {</div><div class="line">                        <span class="keywordflow">if</span> (vpid == 0x2000)</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;pass all PID&#39;s to TS\n&quot;</span>));</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;video pid %d\n&quot;</span>), vpid);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> ((video_fd = open(args.demux_dev, O_RDWR)) &lt; 0) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;failed opening &#39;%s&#39;&quot;</span>), args.demux_dev);</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;  dvb_set_pesfilter %d\n&quot;</span>), vpid);</div><div class="line">                <span class="keywordflow">if</span> (vpid == 0x2000) {</div><div class="line">                        <span class="keywordflow">if</span> (ioctl(video_fd, DMX_SET_BUFFER_SIZE, 1024 * 1024) == -1)</div><div class="line">                                perror(_(<span class="stringliteral">&quot;DMX_SET_BUFFER_SIZE failed&quot;</span>));</div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(video_fd, vpid, DMX_PES_OTHER,</div><div class="line">                                              DMX_OUT_TS_TAP, 0) &lt; 0)</div><div class="line">                                <span class="keywordflow">goto</span> err;</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(video_fd, vpid, DMX_PES_VIDEO,</div><div class="line">                                args.dvr ? DMX_OUT_TS_TAP : DMX_OUT_DECODER,</div><div class="line">                                args.dvr ? 64 * 1024 : 0) &lt; 0)</div><div class="line">                                <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (apid &gt; 0) {</div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;audio pid %d\n&quot;</span>), apid);</div><div class="line">                <span class="keywordflow">if</span> ((audio_fd = open(args.demux_dev, O_RDWR)) &lt; 0) {</div><div class="line">                        PERROR(_(<span class="stringliteral">&quot;failed opening &#39;%s&#39;&quot;</span>), args.demux_dev);</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                        fprintf(stderr, _(<span class="stringliteral">&quot;  dvb_set_pesfilter %d\n&quot;</span>), apid);</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group__demux.html#ga6987e7c2b44f87b629b630c92ce0dc9d">dvb_set_pesfilter</a>(audio_fd, apid, DMX_PES_AUDIO,</div><div class="line">                                args.dvr ? DMX_OUT_TS_TAP : DMX_OUT_DECODER,</div><div class="line">                                args.dvr ? 64 * 1024 : 0) &lt; 0)</div><div class="line">                        <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        signal(SIGALRM, do_timeout);</div><div class="line">        signal(SIGTERM, do_timeout);</div><div class="line">        <span class="keywordflow">if</span> (args.timeout &gt; 0) {</div><div class="line">                signal(SIGINT, do_timeout);</div><div class="line">                alarm(args.timeout);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!check_frontend(&amp;args, parms)) {</div><div class="line">                err = 1;</div><div class="line">                fprintf(stderr, _(<span class="stringliteral">&quot;frontend doesn&#39;t lock\n&quot;</span>));</div><div class="line">                <span class="keywordflow">goto</span> err;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (args.dvr) {</div><div class="line">                <span class="keywordflow">if</span> (args.filename) {</div><div class="line">                        file_fd = STDOUT_FILENO;</div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (strcmp(args.filename, <span class="stringliteral">&quot;-&quot;</span>) != 0) {</div><div class="line">                                file_fd = open(args.filename,</div><div class="line">#ifdef O_LARGEFILE</div><div class="line">                                         O_LARGEFILE |</div><div class="line">#endif</div><div class="line">                                         O_WRONLY | O_CREAT,</div><div class="line">                                         0644);</div><div class="line">                                <span class="keywordflow">if</span> (file_fd &lt; 0) {</div><div class="line">                                        PERROR(_(<span class="stringliteral">&quot;open of &#39;%s&#39; failed&quot;</span>),</div><div class="line">                                               args.filename);</div><div class="line">                                        <span class="keywordflow">return</span> -1;</div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                        get_show_stats(&amp;args, parms, 0);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (file_fd &gt;= 0) {</div><div class="line">                        <span class="keywordflow">if</span> ((dvr_fd = open(args.dvr_dev, O_RDONLY)) &lt; 0) {</div><div class="line">                                PERROR(_(<span class="stringliteral">&quot;failed opening &#39;%s&#39;&quot;</span>), args.dvr_dev);</div><div class="line">                                <span class="keywordflow">goto</span> err;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span> (!timeout_flag)</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;Record to file &#39;%s&#39; started\n&quot;</span>), args.filename);</div><div class="line">                        copy_to_file(dvr_fd, file_fd, args.timeout, args.silent);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                        <span class="keywordflow">if</span> (!timeout_flag)</div><div class="line">                                fprintf(stderr, _(<span class="stringliteral">&quot;DVR interface &#39;%s&#39; can now be opened\n&quot;</span>), args.dvr_dev);</div><div class="line"></div><div class="line">                        get_show_stats(&amp;args, parms, 1);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (args.silent &lt; 2)</div><div class="line">                        get_show_stats(&amp;args, parms, 0);</div><div class="line">        }</div><div class="line">        err = 0;</div><div class="line"></div><div class="line">err:</div><div class="line">        <span class="keywordflow">if</span> (file_fd &gt; 0)</div><div class="line">                close(file_fd);</div><div class="line">        <span class="keywordflow">if</span> (dvr_fd &gt; 0)</div><div class="line">                close(dvr_fd);</div><div class="line">        <span class="keywordflow">if</span> (pat_fd &gt; 0)</div><div class="line">                close(pat_fd);</div><div class="line">        <span class="keywordflow">if</span> (pmt_fd &gt; 0)</div><div class="line">                close(pmt_fd);</div><div class="line">        <span class="keywordflow">if</span> (audio_fd &gt; 0)</div><div class="line">                close(audio_fd);</div><div class="line">        <span class="keywordflow">if</span> (video_fd &gt; 0)</div><div class="line">                close(video_fd);</div><div class="line">        <span class="keywordflow">if</span> (parms)</div><div class="line">                <a name="a58"></a><a class="code" href="group__frontend.html#gaa245d22bee224c452b0acbb718e70acf">dvb_fe_close</a>(parms);</div><div class="line">        <span class="keywordflow">if</span> (args.confname)</div><div class="line">                free(args.confname);</div><div class="line">        <span class="keywordflow">if</span> (args.demux_dev)</div><div class="line">                free(args.demux_dev);</div><div class="line">        <span class="keywordflow">if</span> (args.dvr_dev)</div><div class="line">                free(args.dvr_dev);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span> err;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
